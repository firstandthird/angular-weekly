/*!
 * angular-weekly - Weekly Calendar Angular directive
 * v0.0.1
 * https://github.com/jgallen23/angular-weekly/
 * copyright Greg Allen 2013
 * MIT License
*/
!function(a){var b=a.template,c={};opts={openTag:"<%",closeTag:"%>"};var d=function e(a,b){var d=/\W/.test(a)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split(opts.openTag).join("	").replace(new RegExp("((^|"+opts.closeTag+")[^	]*)'","g"),"$1\r").replace(new RegExp("	=(.*?)"+opts.closeTag,"g"),"',$1,'").split("	").join("');").split(opts.closeTag).join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):c[a]=c[a]||e(a);return b?d(b):d};d.options=opts,d.noConflict=function(){return a.template=b,d},a.template=d}(window),function(a,b){var c=0,d=function(a){this.obj=a};d.prototype.__init=function(a){b.extend(this,this.obj),this.id=c++,this.obj.defaults=this.obj.defaults||{},b.extend(this,this.obj.defaults,a),b("body").trigger("FidelPreInit",this),this.setElement(this.el||b("<div/>")),this.init&&this.init(),b("body").trigger("FidelPostInit",this)},d.prototype.eventSplitter=/^(\w+)\s*(.*)$/,d.prototype.setElement=function(a){this.el=a,this.getElements(),this.delegateEvents(),this.dataElements(),this.delegateActions()},d.prototype.find=function(a){return this.el.find(a)},d.prototype.proxy=function(a){return b.proxy(a,this)},d.prototype.getElements=function(){if(this.elements)for(var a in this.elements){var b=this.elements[a];this[b]=this.find(a)}},d.prototype.dataElements=function(){var a=this;this.find("[data-element]").each(function(c,d){var e=b(d),f=e.data("element");a[f]=e})},d.prototype.delegateEvents=function(){if(this.events)for(var a in this.events){var b=this.events[a],c=a.match(this.eventSplitter),d=c[1],e=c[2],f=this.proxy(this[b]);""===e?this.el.on(d,f):this[e]&&"function"!=typeof this[e]?this[e].on(d,f):this.el.on(d,e,f)}},d.prototype.delegateActions=function(){var a=this;a.el.on("click","[data-action]",function(c){var d=b(this),e=d.attr("data-action");a[e]&&a[e](c,d)})},d.prototype.on=function(a,b){this.el.on(a+".fidel"+this.id,b)},d.prototype.one=function(a,b){this.el.one(a+".fidel"+this.id,b)},d.prototype.emit=function(a,b,c){var d=c?".fidel"+this.id:"";this.el.trigger(a+d,b)},d.prototype.hide=function(){if(this.views)for(var a in this.views)this.views[a].hide();this.el.hide()},d.prototype.show=function(){if(this.views)for(var a in this.views)this.views[a].show();this.el.show()},d.prototype.destroy=function(){this.el.empty(),this.emit("destroy"),this.el.unbind(".fidel"+this.id)},d.declare=function(a){var b=function(a,b){this.__init(a,b)};return b.prototype=new d(a),b},d.onPreInit=function(a){b("body").on("FidelPreInit",function(b,c){a.call(c)})},d.onPostInit=function(a){b("body").on("FidelPostInit",function(b,c){a.call(c)})},function(a){a.declare=function(b,c){a.fn[b]=function(){var e,f,g=Array.prototype.slice.call(arguments),h=g.shift();return f=this.each(function(){var f=a(this),i=f.data(b);if(!i){var j=d.declare(c),k=a.extend({},h,{el:f});i=new j(k),f.data(b,i)}"string"==typeof h&&(e=i[h].apply(i,g))}),e||f},a.fn[b].defaults=c.defaults||{}},a.Fidel=d}(jQuery),a.Fidel=d}(window,window.jQuery||window.Zepto),function(a){a.template=template.noConflict(),a.prototype.render=function(b){var c=this.template?this.template:$("#"+this.templateId).html();this.el.html(a.template(c,b))}}(window.Fidel),function(a){a.declare("weekly",{defaults:{startTime:8,endTime:6,weekOffset:0,currentDate:new Date,autoRender:!0,template:'<div class="days"><% for (var i = 0; i < dates.length; i++) { var date = dates[i]; %>  <div class="day" style="width:<%= 100/dates.length %>%" data-date="<%= date.getFullYear() %>-<%= date.getMonth() %>-<%= date.getDate() %>"><%= date.toDateString() %></div><% } %></div><div class="times"><% for (var i = 0; i < times.length; i++) { var time = times[i]; %>  <div class="time" data-time="<%= time %>"><%= time %></div><% } %></div><div class="grid"><% for (var i = 0; i < dates.length; i++) { var date = dates[i]; %>  <div class="day" style="width:<%= 100/dates.length %>%" data-date="<%= date.getFullYear() %>-<%= date.getMonth() %>-<%= date.getDate() %>">    <% for (var ii = 0; ii < times.length; ii++) { var time = times[ii]; %>      <div class="time" data-time="<%= time %>">&nbsp;</div>    <% } %>  </div><% } %></div>'},init:function(){this.events=[],this.autoRender&&this.update()},update:function(){this.render({dates:this.getDates(),times:this.getTimes()});for(var a=0,b=this.events.length;b>a;a++)this.renderEvent(this.events[a]);this.timeDifference=this.endTime+13-this.startTime,this.registerClickToCreate(),this.highlightToday()},highlightToday:function(){var a=new Date;this.el.find('[data-date="'+this.timef("%Y-%n-%j",a)+'"]').addClass("today")},registerClickToCreate:function(){this.mouseDown=!1,this.pendingEvent=null,this.pendingEventStart=null;var b=this.el.find(".grid .day");b.unbind("mousedown mousemove mouseup mouseout"),b.on("mousedown",this.proxy(function(){this.mouseDown=!0,this.pendingEvent&&(this.pendingEvent.remove(),this.pendingEvent=null)})),b.on("mouseup",this.proxy(function(){if(this.mouseDown=!1,this.pendingEvent){var a=this.pendingEvent.data(),b=a.date.split("-");this.addEvent({start:new Date(b[0],b[1],b[2],a.starttime),end:new Date(b[0],b[1],b[2],a.endtime)}),this.pendingEvent.remove(),this.pendingEvent=null,this.pendingEventStart=null}})),b.on("mousemove",this.proxy(function(b){if(this.mouseDown){var c=a(b.currentTarget),d=c.offset(),e=b.clientY-d.top,f=a(b.currentTarget).height(),g=Math.round(f/this.timeDifference),h=Math.floor(e/g)*g,i=Math.ceil(e/g)*g;null===this.pendingEventStart&&(this.pendingEventStart=h),(null===this.pendingEventEnd||i>this.pendingEventStart)&&(this.pendingEventEnd=i),this.pendingEvent||(c.append('<div class="event-pending"></div>'),this.pendingEvent=c.find(".event-pending"),this.pendingEvent.data("date",c.data("date"))),this.pendingEvent.css({top:this.pendingEventStart,bottom:f-this.pendingEventEnd}),this.pendingEvent.data("starttime",(this.pendingEventStart/g||0)+this.startTime),this.pendingEvent.data("endtime",(this.pendingEventEnd/g||1)+this.startTime)}})),b.on("mouseleave",this.proxy(function(){this.mouseDown&&b.trigger("mouseup")}))},getDates:function(){for(var a=this.currentDate,b=a.getDate()-a.getDay(),c=7,d=[],e=new Date(a.setDate(b+this.weekOffset*c)),f=0,g=c;g>f;f++){var h=new Date(e.setDate(e.getDate()-e.getDay()+f));d.push(h)}return d},getTimes:function(){for(var a=this.endTime+12,b=[],c=this.startTime;a>=c;c++){var d=c>12?c-12:c,e=d+":00 ";e+=c>11?"PM":"AM",b.push(e)}return b},nextWeek:function(){this.changeDate(7)},prevWeek:function(){this.changeDate(-7)},changeDate:function(a){this.currentDate.setDate(this.currentDate.getDate()+a),this.autoRender&&this.update()},renderEvent:function(b){var c=b.start.getFullYear()+"-"+b.start.getMonth()+"-"+b.start.getDate(),d=b.start.toTimeString().slice(0,5);b.end.getFullYear()+"-"+b.end.getMonth()+"-"+b.end.getDate();var e=b.end.toTimeString().slice(0,5),f=100-this.getTimeOffsetPercent(d),g=this.getTimeOffsetPercent(e),h=a('<div class="event"></div>');h.data(b),h.css({top:f+"%",bottom:g+"%"}).append('<a href="#" data-action="removeEvent" class="delete">Ã—</a><div class="event-title">'+d+'</div><div class="event-name">'+b.name+'</div><div class="event-desc">'+b.description+"</div>"),this.el.find('.grid .day[data-date="'+c+'"]').append(h)},toFraction:function(a){if(-1===a.toString().indexOf(":"))return a;var b=a.toString().split(":");return parseFloat(b[0]+"."+100/(60/b[1]))},getTimeOffsetPercent:function(a){a=this.toFraction(a)-this.startTime;var b=this.timeDifference-a;0>b&&(b=a-this.timeDifference);var c=100*(b/this.timeDifference);return c},timef:function(a,b){if(!(!b instanceof Date)){var c="January|February|March|April|May|June|July|August|September|October|November|December".split("|"),d="Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday".split("|");return a.replace(/%d|%D|%j|%l|%S|%w|%F|%m|%M|%n|%Y|%y|%a|%A|%g|%G|%h|%H|%i|%s|%u|%e/g,function(a){switch(a){case"%d":return("0"+b.getDate()).substr(-2,2);case"%D":return d[b.getDay()].substr(0,3);case"%j":return b.getDate();case"%l":return d[b.getDay()];case"%S":return 1===b.getDate()?"st":2===b.getDate()?"nd":3===b.getDate()?"rd":"th";case"%w":return b.getDay();case"%F":return c[b.getMonth()];case"%m":return("0"+b.getMonth()).substr(-2,2);case"%M":return c[b.getMonth()].substr(0,3);case"%n":return b.getMonth();case"%Y":return b.getFullYear();case"%y":return b.getFullYear().toString().substr(-2,2);case"%a":return b.getHours()>11?"pm":"am";case"%A":return b.getHours()>11?"PM":"AM";case"%g":return b.getHours()>11?b.getHours()-12:b.getHours();case"%G":return b.getHours();case"%h":return("0"+(b.getHours()>11?b.getHours()-12:b.getHours())).substr(-2,2);case"%H":return("0"+b.getHours()).substr(-2,2);case"%i":return("0"+b.getMinutes()).substr(-2,2);case"%s":return("0"+b.getSeconds()).substr(-2,2);case"%u":return b.getMilliseconds();case"%e":return b.getTimezoneOffset()}})}},addEvent:function(b){b=a.extend({name:"",description:"",start:null,end:null},b),b.id=this.events.length,this.renderEvent(b),this.events.push(b),this.el.trigger("addEvent",[b])},removeEvent:function(b){var c=a(b.target).parents(".event"),d=c.data();return this.events.splice(d.id,1),c.remove(),this.el.trigger("removeEvent",d),!1}})}(jQuery),function(){var a=angular.module("weekly",[]);a.directive("weekly",function(){return{restrict:"EA",link:function(a,b){b.addClass("weekly").weekly()}}})}();